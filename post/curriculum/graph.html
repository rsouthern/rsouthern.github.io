<html>

<body>
  <!-- Includes for data loading and visualisation-->
  <script src="https://d3js.org/d3.v6.js"></script>

  <!-- Includes to input data from google docs / sheets-->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body {
      background: #FFF;
      margin: 2px;
    }

    img {
      border-radius: 10px;
      padding: 2px;
    }

    pre {
      display: none;
    }

    p {
      white-space: pre;
    }

    .tooltip-hover {
      position: absolute;
      z-index: 10;
      visibility: visible;
      background-color: white;
      text-align: left;
      padding: 4px;
      border-radius: 4px;
      font-weight: bold;
      color: black;
      font: 12px sans-serif;
      border-style: solid;
      opacity: 0.8;
      border-width: 1px;
    }
  </style>


  <script>
    google.charts.load('current');
    google.charts.setOnLoadCallback(init);

    function init() {
      // Load the spreadsheet data using a query
      //var url = 'https://docs.google.com/spreadsheets/d/11BcByHOP4BhCnN3YeADMSn5qcqP_xR6ODQT9UC6Flmg/gviz/tq?sheet=BAVE'; // BAVE
      var url = 'https://docs.google.com/spreadsheets/d/11BcByHOP4BhCnN3YeADMSn5qcqP_xR6ODQT9UC6Flmg/gviz/tq?sheet=BACATA'; // BACATA
      //var url = 'https://docs.google.com/spreadsheets/d/11BcByHOP4BhCnN3YeADMSn5qcqP_xR6ODQT9UC6Flmg/gviz/tq?sheet=BACAAD'; // BACAAD
      var query = new google.visualization.Query(url);
      query.setQuery('select *');
      query.send(processSheetsData);
    }

    function unitText(d) {
      var retval = "";
      retval = retval.concat(d['Aims'] + '\n\n' + d['Intended Learning Outcomes']);
      return retval;
    }

    function unitModal(title, text) {
      console.log(title);
    }

    // Create a tooltip div for displaying tooltip information
    var tooltip = d3.select("body")
      .append("div")
      .attr('data-html', 'true')
      .attr('class', 'tooltip-hover')
      .style('opacity',0);

    function formatTooltipInfo(d) {
      var ttStr = "<b>L" + d['Level'] + "(" + d['Core or Option'] + "): " + d['Unit Title'] + "</b><br/>";
      //ttStr = ttStr + "<b>Aims:</b><br/>"+d['Aims'].replace(/(?:\r\n|\r|\n)/g, '<br/>')+"<br/>";
      ttStr = ttStr + "Having completed this unit the student is expected to:<br/>"+d['Intended Learning Outcomes'].replace(/(?:\r\n|\r|\n)/g, '<br/>')+"<br/>";
      ttStr = ttStr + "<b>Keywords:</b>"+d['Keywords']+"<br/>";
      ttStr = ttStr + "<i>"+d['Credit']+"</i><br/>";
      return ttStr;
    }

    function processSheetsData(response) {
      var gdata = response.getDataTable();
      var columns = gdata.getNumberOfColumns();
      var rows = gdata.getNumberOfRows();

      // append column headings
      var csvData = "";
      for (var c = 0; c < columns; c++) {
        csvData += "\"" + gdata.getColumnLabel(c) + "\"";
        csvData += (c == columns - 1) ? '\n' : ',';
      }
      // append row headings
      for (var r = 0; r < rows; r++) {
        var mapObj = { colLabels: gdata.getFormattedValue(r, 0) };
        for (var c = 0; c < columns; c++) {
          csvData += "\"" + gdata.getFormattedValue(r, c) + "\"";
          csvData += (c == columns - 1) ? '\n' : ',';
        }
      }

      // Use d3 to parse the string as csv data
      data = d3.csvParse(csvData);

      // The path to our icons
      var prefix = "/unit_icons/";

      // Iterate over all rows of our d3 data
      data.forEach(function (d) {

        // This is the full path to our icon
        var imgStr = prefix.concat(d['Icon']);

        // Append a <img height=xx src=xx> tag to the body
        /*
        var imgElement = document.createElement('img');
        imgElement.setAttribute('src', imgStr);
        imgElement.setAttribute('height', 80);
        imgElement.setAttribute('id', d['Unit Title']);
        //var modalClickStr = 'unitModal(\"' + d['Unit Title'] + '\",\"' + unitText(d) + '\")';
        var modalClickStr = 'unitModal(\"' + d['Intended Learning Outcomes'].replace(/(?:\r\n|\r|\n)/g, '\n') + '\")';
        imgElement.setAttribute('tooltip', modalClickStr);
        imgElement.setAttribute('onClick', modalClickStr);
        document.body.appendChild(imgElement);*/


        console.log(d);
        d3.select("body")
          .append("img")
          .attr("height", 100)
          .attr("src", imgStr)
          .on("mouseover", function (document) {
            var ttStr = formatTooltipInfo(d);
            tooltip.transition()		
                .duration(500)		
                .style("opacity", .9);
            return tooltip.style("visibility", "visible")
              .html(ttStr)
              .style("top", (event.pageY - 30) + "px")
              .style("left", event.pageX + "px");
          })          
          .on("mouseout", function () {
            //tooltip.transition()		
                //.duration(500)		
                //.style("opacity", 0);            
          });
      });
    }




  </script>

</body>

</html>